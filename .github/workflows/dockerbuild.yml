name: Docker Build & Push (Multi-Service)

on:
  workflow_call:
    inputs:
      build_args:
        description: 'Optional Docker build arguments in format key=value,key=value'
        type: string
        required: false
      platforms:
        description: 'Target platforms (comma-separated, e.g. linux/amd64,linux/arm64)'
        type: string
        required: false
        default: linux/amd64,linux/arm64

jobs:
  setup-context:
    uses: eclipse-xfsc/dev-ops/.github/workflows/build-context.yml@main
    secrets: inherit

  docker-build:
    needs: setup-context
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Test
        run: |
            tree
            cat ./github/harbor.config
      - name: Docker login to Harbor
        run: |
          echo "${{ secrets.HARBOR_PASSWORD }}" | docker login "${{ secrets.HARBOR_OCI }}" \
            --username "${{ secrets.HARBOR_USERNAME }}" \
            --password-stdin

      - name: Find and build Docker images (multi-arch)
        run: |
          IMAGE_TAG="${{ needs.setup-context.outputs.image_tag }}"
          PLATFORMS="${{ inputs.platforms }}"
          echo "🔖 Tag: $IMAGE_TAG"
          echo "🧬 Platforms: $PLATFORMS"

          # Convert comma-separated build_args string to space-separated --build-arg args
          BUILD_ARGS=""
          if [[ -n "${{ inputs.build_args }}" ]]; then
            IFS=',' read -ra ARGS <<< "${{ inputs.build_args }}"
            for arg in "${ARGS[@]}"; do
              BUILD_ARGS+="--build-arg $arg "
            done
          fi

          find . -type f -path "*/deployment/docker/Dockerfile" | while read dockerfile; do
            SERVICE_DIR=$(dirname "$(dirname "$dockerfile")")
            SERVICE_NAME=$(basename "$SERVICE_DIR")
            IMAGE="${{ secrets.HARBOR_OCI }}/${{ secrets.HARBOR_PROJECT }}/$SERVICE_NAME:$IMAGE_TAG"

            echo "🐳 Building $SERVICE_NAME → $IMAGE"

            docker buildx build \
              --platform "$PLATFORMS" \
              --file "$dockerfile" \
              $BUILD_ARGS \
              --push \
              --tag "$IMAGE" \
              "$SERVICE_DIR"
          done
